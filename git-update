#!/bin/sh
# $Id: git-update,v 1.5 2017/03/30 22:34:30 friedman Exp $

git_revno()
{
    git rev-list -n1 HEAD
}

bare_repo_p()
{
    case `git config --bool --local --get core.bare` in
        true ) return 0 ;;
        *    ) return 1 ;;
    esac
}

has_remotes()
{
    # exit code 1 if no matches
    git config --local --get-regexp '^remote\..*\.url$' > /dev/null
}

main()
{
    cd "${1-.}" || exit $?
    case $2 in
        --rebase ) rebase=--rebase=preserve ;;
    esac

    if ! has_remotes; then
        #echo "repository has no upstream remotes"
        return 0
    fi

    if bare_repo_p; then
        git fetch --all
    else
        revno_old=`git_revno`
        git pull $rebase --all --prune --no-stat --recurse-submodules
        revno_new=`git_revno`

        git-restore-commit-mtime $revno_old..$revno_new
    fi
}

main "$@"

# eof
